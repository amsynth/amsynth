#include <non/nsm.h>                                          
#include "NsmClient.h"                                          
#include "main.h"
#include "DebugMessage.h"

using namespace std ;


NsmClient *NSMClient ;

DebugMessage NsmClient::debugMessage ;


void NsmClient::Debug (string message) {
  //DebugString (message) ;
  debugMessage.SendMessage (message) ;
}




int NsmClient::openCallback (const char *path, const char *displayName, const char *clientId, char **outMsg, void *userData) {
  (void)outMsg ;

  NsmClient *nsmClient = (NsmClient*)userData ;
  nsmClient->Debug ("NsmClient: openCallback()\n") ;
  return nsmClient->open (path, displayName, clientId) ;                                  
}                                                         
                                                          
int NsmClient::saveCallback (char **outMsg, void *userData) {
  (void)outMsg ;

  NsmClient *nsmClient = (NsmClient*)userData ;
  nsmClient->Debug ("NsmClient: saveCallback()\n") ;
  return nsmClient->save () ;                                      
}                                                         
                                                          

void NsmClient::activeCallback (int isActive, void *userData) {
  NsmClient *nsmClient = (NsmClient*)userData ;
  nsmClient->Debug ("NsmClient: activeCallback()\n") ;

  if (isActive == 1) {
    nsmClient->Debug ("Nsm is active\n") ;
    nsmClient->active (true) ;
  }
  else {
    nsmClient->Debug ("Nsm is NOT active\n") ;
    nsmClient->active (false) ;
  }
}                                                         

void NsmClient::setOpenResult (int result) {
  openResult = result ;
}

void NsmClient::setSaveResult (int result) {
  saveResult = result ;
}

void NsmClient::setActiveResult (int result) {
  activeResult = result ;
}
                                                          

NsmClient::NsmClient (std::string programName) : nsm(0) {
  NSMClient = this ;
  this->programName = programName ;

  openResult = -1 ;
  saveResult = -1 ;
  activeResult = -1 ;
}

void NsmClient::Init (void) {
  Debug ("NsmClient: Constructor()\n") ;

  const char *nsm_url = getenv("NSM_URL") ;

  if (nsm_url) {
    Debug ("nsm_url: ") ;
    Debug (string(nsm_url)) ;
    Debug ("\n") ;

    nsm = nsm_new ();

    nsm_set_open_callback (nsm, openCallback, this);
    nsm_set_save_callback (nsm, saveCallback, this);
    nsm_set_active_callback (nsm, activeCallback, this);

    if (nsm_init_thread (nsm, nsm_url) == 0) {
      nsm_send_announce( nsm, "AmSynth", "", programName.c_str() );
      nsm_thread_start (nsm) ;
    }
    else {
      nsm_free( nsm );
      nsm = 0;
    }

    Debug ("NsmClient: Registered Callbacks\n") ;
  }
}



NsmClient::~NsmClient (void) {
  Debug ("NsmClient: Destructor()\n") ;
  if (nsm != 0) {
    nsm_thread_stop (nsm) ;
    nsm_free( nsm );
  }
}

int NsmClient::open (const char* name, const char* displayName, const char* clientId) {
  Debug ("NsmClient: open()\n") ;
  Open (string(name), string(displayName), string(clientId)) ;

  Debug ("Open Result: ") ;
  Debug (to_string (openResult)) ;
  Debug ("\n") ;

  return openResult ;
}

int NsmClient::save (void) {
  Debug ("NsmClient: save()\n") ;
  Save () ;

  Debug ("Save Result: ") ;
  Debug (to_string (saveResult)) ;
  Debug ("\n") ;

  return saveResult ;
}

void NsmClient::active (bool isActive) {
  Debug ("NsmClient: active()\n") ;
  Active (isActive) ;

  Debug ("Active Result: ") ;
  Debug (to_string (activeResult)) ;
  Debug ("\n") ;
}
